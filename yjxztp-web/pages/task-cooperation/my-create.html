<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我创建的</title>
  <!-- layui style -->
  <link rel="stylesheet" href="../../assets/plugins/layui/css/layui.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/plugins/datatables/datatable.css">
  <!-- page style -->
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
    }

    body {
      padding: 20px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div class="table-toolbar">
    <div class="table-toolbar-left">
      <div class="search">
        <i class="layui-icon layui-icon-search"></i>
        <input class="search-ipt" type="text" placeholder="请输入项目名称，按“Enter”键进行搜索">
      </div>
    </div>
    <div class="table-toolbar-right layui-form">
      <button class="layui-btn layui-btn-text layui-btn-sm layui-btn-primary table-toolbar-switch">
        <input type="checkbox" lay-skin="switch" name="showSub">
        显示子任务
      </button>
      <button class="layui-btn layui-btn-text layui-btn-sm layui-btn-primary">
        筛选 <i class="layui-icon layui-icon-down"></i>
      </button>
      <button id="colsvis" class="layui-btn layui-btn-text layui-btn-sm layui-btn-primary">
        显示列 <i class="layui-icon layui-icon-down"></i>
      </button>
    </div>
  </div>
  <table id="my-create-table" class="layui-table" lay-skin='line'></table>
  <div style="display: none;" id="columnsVis">
    <div class="layer-box__header"></div>
    <div class="layer-box__body layui-form">
      <ul>
        <li>
          项目 <input data-column="project" type="checkbox" checked lay-skin="switch">
        </li>
        <li>
          执行人 <input data-column="executor" type="checkbox" checked lay-skin="switch">
        </li>
        <li>
          截止时间 <input data-column="endtime" type="checkbox" checked lay-skin="switch">
        </li>
        <li>
          任务分类 <input data-column="type" type="checkbox" checked lay-skin="switch">
        </li>
        <li>
          创建时间 <input data-column="starttime" type="checkbox" checked lay-skin="switch">
        </li>
      </ul>
    </div>
  </div>
</body>
<!-- datatables -->
<script type="text/javascript"
  src="https://cdn.datatables.net/v/dt/jq-3.3.1/dt-1.10.21/fh-3.1.7/rg-1.1.2/sl-1.3.1/datatables.min.js"></script>
<!-- layui -->
<script src="../../assets/plugins/layui/layui.js"></script>
<!-- 模拟数据 -->
<script src="https://cdn.bootcdn.net/ajax/libs/Mock.js/1.0.1-beta3/mock-min.js"></script>
<!-- page js -->
<script>
  // 模拟 ajax 请求数据
  function MockData() {
    return new Promise((r, j) => {
      var data = Mock.mock({
        "data|10-20": [
          {
            "id|+1": 0,
            "num|+1": 1,
            "name|1": "@ctitle(3,8)",
            "executor|1": "@cname",
            "project|1": ["项目1", "项目2"],
            "type|1": ["科研类", "创业类"],
            "endtime|1": "@date",
            "starttime|1": "@date",
            "status|1": ["invalid", "normal", "done"],
          },
        ],
      });
      r(data.data);
    });
  }
  function createIcon(icon) {
    if (!icon) return "";
    return `<i class="layui-icon">${icon}</i>`;
  }
  function Button(text, theme, size, radius, icon) {
    if (!text) return null;
    var baseClass = "layui-btn-";
    var themeClass = theme ? baseClass + theme : "";
    var sizeClass = size ? baseClass + size : "";
    var radiusClass = radius ? baseClass + "radius" : "";
    var BtnClass = `layui-btn datatable-btn ${themeClass} ${sizeClass} ${radiusClass}`;
    return $(`<button class="${BtnClass}">${createIcon(icon)}${text}</button>`);
  }

  // 生成表格
  var tableEl = $("#my-create-table");
  MockData().then(function (data) {
    tableEl.DataTable({
      scrollY: "calc(100vh - 128px)",
      info: false,
      paging: false,
      searching: false,
      order: [],
      data: data,
      columnDefs: [{ orderable: false, targets: "_all" }],
      createdRow(row, data, dataIndex) {
        // 状态 class
        $(row).addClass(`datatable-status-${data.status}`);
      },
      columns: [
        {
          title: "序号",
          data: "num",
          width: "30px",
        },
        {
          title: "项目名称",
          data: "name",
        },
        {
          title: "执行人",
          data: "executor",
          name: "executor",
        },
        {
          title: "项目",
          data: "project",
          name: "project",
          orderable: true,
        },
        {
          title: "任务类型",
          data: "type",
          name: "type",
        },
        {
          title: "截止时间",
          data: "endtime",
          name: "endtime",
          orderable: true,
        },
        {
          title: "创建时间",
          data: "starttime",
          name: "starttime",
          orderable: true,
        },
        {
          title: "操作",
          data: null,
          defaultContent: "",
          width: "180px",
          createdCell(cell, cellData, rowData, rowIndex, colIndex) {
            if (rowData.status === "done" || rowData.status === "invalid") {
              var restartBtn = new Button("重启", "", "sm");
              restartBtn.on("click", function () {
                $(this).trigger(
                  {
                    type: "restartClick",
                    cell,
                  },
                  rowData
                );
              });
            }
            if (rowData.status === "normal") {
              var doneBtn = new Button("完成", "", "sm");
              doneBtn.on("click", function () {
                $(this).trigger(
                  {
                    type: "doneClick",
                    cell,
                  },
                  rowData
                );
              });
            }
            if (rowData.status !== "invalid") {
              var subTaskBtn = new Button("+子任务", "", "sm");
              subTaskBtn.on("click", function () {
                $(this).trigger(
                  {
                    type: "addSubTaskClick",
                    cell,
                  },
                  rowData
                );
              });
            }
            $(cell).append([restartBtn, doneBtn, subTaskBtn]);
          },
        },
      ],
    });
  });

  layui.use(["layer", "form"], function () {
    var layer = layui.layer,
      form = layui.form;
    var datatable = tableEl.DataTable();
    var $search = $("#search");
    // 监听操作栏按钮点击
    tableEl.on("restartClick", function (e, data) {
      layer.msg("重启" + JSON.stringify(data));
    });
    tableEl.on("doneClick", function (e, data) {
      layer.msg("完成" + JSON.stringify(data));
    });
    tableEl.on("addSubTaskClick", function (e, data) {
      layer.msg("+子任务" + JSON.stringify(data));
    });
    // 更新数据
    $search.on("keyup", function (e) {
      if (e.keyCode == 13) {
        MockData().then(function (data) {
          datatable.clear();
          datatable.rows.add(data);
          datatable.draw();
        });
      }
    });
    // 弹出式菜单
    $("#colsvis").on("click", function (e) {
      var layerDom = $(columnsVis);
      layer.open({
        triggerEle: $(this),
        title: "",
        type: 1,
        offset: "eb",
        content: layerDom,
        shade: 0.001,
        shadeClose: true,
        closeBtn: 0,
        move: false,
      });
    });
    // 切换列显隐
    form.on("switch", function (data) {
      var column = datatable.column($(data.elem).attr("data-column") + ":name");
      column.visible(data.elem.checked);
    });
    // 外部按列降序
    $("#sortByEndtime").on("click", function () {
      var column = datatable.column("endtime:name");
      column.order('desc').draw();
    });
  });
</script>

</html>
